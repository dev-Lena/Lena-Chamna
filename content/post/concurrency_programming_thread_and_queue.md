---
title: "Concurrency_programming_thread_and_queue"
date: 2020-11-26T22:05:34+09:00
images: []
categories: []
tags: []
authors: []
---



authors = [
    "Lena"
]
title = "동시성 프로그래밍(Concurrency programming): 스레드와 큐(thread and queue)"
date = 2020-11-26T22:05:34+09:00
description = "Concurrency programming: introduce thread and queue in iOS"
tags = [
    "iOS", "Concurrency programming", "GCD", "Concurrent Queue", "Serial Queue", "Sync", "Async"
]
categories = [
     "iOS", "Concurrency programming", "GCD"
]
series = ["Concurrency programming"]
images = [
  "/images/Coordinator_Pattern _advanced_wide_ver.png"
]
draft = false

+++

[동시성 프로그래밍 시리즈] Sync vs Async / Serial vs Concurrent에 대해 자세히 알아봅니다 🙌🏻<br>

<br>

<!--more-->

> **비동기(Async)와 동시(Concurrent)는 같은 말일까요?** 

이 질문에 대한 답을 찾아가봅시다.

이 질문에 정확히 답변을 하기 위해서는 비동기란 무엇인지, 동시란 무엇인지 이해하고 있어야 하겠죠? 아래 본문에서는 이런 내용을 다룰 것입니다.





##    <  📑 목차  >

* 알아두기 (iOS 에서의 작업 처리 방식)
* 큐(Queue)(대기열/대기행렬)
* Synchronous(동기) vs Asynchronous(비동기)
* Serial(직렬) vs Concurrent(동시)
* 스레드의 작업 처리 방식과 큐의 작업 분산 방식 조합
* 디스패치큐(GCD) 사용시 알아야 할 점들과 이유
  * UI업데이트는 메인큐에서 해야하는 이유
  * 메인큐에서 sync 메서드를 사용하면 안되는 이유
  * weak, strong 캡처 주의
* 함께보면 좋을 자료들
* 참고



## 알아두기

* 먼저 스레드에 대한 개념을 알고 읽으면 좋을 것같습니다.(사실 반드시 스레드에 대해서 알고 있는 상태에서 이후 내용을 읽으셨으면 좋겠습니다 👻) - 위키피디아 링크: [스레드(Thread)](https://en.wikipedia.org/wiki/Thread_(computing))

* 동시성 프로그래밍의 시작은 "수행해야 할 작업(Task)들을 한 개의 스레드에서만이 아니라 다른 스레드에서도 어떻게 동시에 일을 시킬 수 있을까?" 라는 아이디어에서 시작합니다.



### 큐(Queue)(대기열/대기행렬)

* 직접적으로 스레드를 관리하지 않고 큐(Queue) 개념을 사용하여 작업을 분산 처리합니다. iOS에서는 작업을 큐(Queue)에 보내면 OS가 알아서 다른 스레드로 분산처리를 해줍니다. 즉, 개발자가 스레드를 직접적으로 만들어서 큐에 작업을 넣어주지 않아도 됩니다. 개발자는 큐를 만들어서 큐에 작업을 넣어주고, 그러면 큐가 알아서 스레드를 생성해서 스레드에 작업을 배치합니다. 또한 iOS에서는 GCD/Operation을 사용해 시스템에서 알아서 쓰레드 숫자를 관리합니다. GCD/Operation이 스레드보다 더 높은 레벨/차원에서 일을 한다고 이해하면 좋을 것 같네요.
* 큐는 항상 선입선출(FIFO: First In First Out)로 동작합니다. 
* 먼저 들어온 작업이 다른 스레들에 먼저 배치가 되지만 그렇다고 먼저 끝나는 것이 보장하는 것은 아닙니다.  

 

그럼 2개 이상의 스레드를 사용하여 작업을 처리하고 싶을 때 큐에 작업을 보내면 되겠네요.

그렇다면 작업을 어떻게 큐에 보낼까요?

iOS에서는 DispatchQueue를 사용합니다. 

```swift
DispatchQueue.global().async{
  // 작업1
  // 이 클로저 안에 있는 코드들이 작업의 한 단위라고 볼 수 있습니다.
} // 작업1을 글로벌큐에 비동기적으로 보낼꺼야.라는 의미입니다.

// 위의 코드를 아래와 같이 표현할 수도 있습니다.
let queue = DispatchQueue.global() 
queue.async { 
  
} 
```

Dispatch의 사전적인 의미는 보내다, 파견하다입니다. 그러니까 DispatchQueue는 큐에 보내다 정도로 이해할 수 있겠네요.

GCD GCD 단어만 많이 들어봤었는데 GCD(Grand Central Dispatch)를 보통 DispatchQueue라고 말하기도 한다고 하네요.

GCD는 간단한 일이나 위에 예제 코드에서 처럼 클로저로 묶은 작업과 같이 함수를 사용하는 작업에서 주로 사용합니다.

참고로, GCD하면 Operation 개념도 함께 많이 나오죠? Operation은 작업이라는 뜻으로 GCD를 기반으로 한 OperationQueue는 대기열을 말하며 복잡한 일이나 데이터와 기능을 캡슐화한 객체를 취소하거나 순서를 지정하거나 일시중지(상태 추적)할 때 사용합니다. (이 글에서는 다루지 않고 다음에 다루겠습니다.)



## Synchronous(동기) vs Asynchronous(비동기)

메인스레드에서 작업들을 다른 스레드로 분산처리 시키고 그 작업이 끝날때 까지 기다릴지 기다리지 않을지에 대한 개념입니다.

| 비동기(Async)                                                | 동기(Sync)                                                   |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| 작업을 메인 스레드가 아닌 다른 스레드에서 하도록 시킨 후, 그 작업이 끝나길 기다리지 않고 다음 작업을 진행합니다. <br>(기다리지 않아도 다음 작업을 생성할 수 있습니다.) | 작업을 메인 스레드가 아닌 다른 스레드에서 하도록 시킨 후, 그 작업이 끝나길 기다렸다가 작업이 완료되면 다음 작업을 진행합니다. <br/>(기다렸다가 다음 작업을 생성할 수 있습니다.) |

* 비동기(Async)

  ```swift
  DispatchQueue.global().async{
  
  }
  // 원래의 작업이 진행되고 있던 곳(메인스레드)에서 디스패치 글로벌 큐로 작업을 보낸 후 그 작업이 끝날때 까지 기다리지 않습니다.
  ```

  참고로 iOS에서 네트워크 통신을 위해 사용하는 `URLSession(configuration:).dataTask(with:)` 은 내부적으로 비동기 처리가 되어있습니다. 그래서 이 메서드를 사용하면 내부적으로 알아서 다른 스레드를 생성해서 작업을 처리하고 있다고 이해하면 됩니다.

  ```swift
  URLSession(configuration: .ephemeral).dataTask(with: url){
    data, response, error in 
    ....
  }
  ```

  

* 동기(Sync)

  ```swift
  DispatchQueue.global().sync{
  
  }
  // 원래의 작업이 진행되고 있던 곳(메인스레드)에서 디스패치 글로벌 큐로 작업을 보낸 후 그 작업이 끝날 때까지 동기적으로 기다립니다.
  ```

  

## Serial(직렬) vs Concurrent(동시)

이 두 개념은 큐의 특성에 대한 개념입니다. 

* Serial

시리얼큐는 큐가 받아들인 작업들을  하나의 스레드로만 보내 처리하는 큐입니다. 시리얼큐는 순서가 중요한 작업을 처리할 때 사용합니다.

* Concurrent

컨커런트큐는 받아들인 작업을 여러 개의 스레드로 나눠서 보내 처리하는큐입니다. 이 때 몇 개의 쓰레드로 분산할지는 시스템(OS)이 알아서 결정합니다. 컨커런트큐는 각자 중요도나 작업 성격이 독립적이지만 유사한 여러 개의 작업을 처리할 때 사용합니다. (예를 들면 테이블 뷰 각 셀에 들어가는 이미지나 텍스트 데이터를 API에서 가지고 올 때가 있습니다.)

동시(Cocurrent) 큐는 (보통 메인에서) 분산처리 시킨 작업을 **다른 여러 개의 쓰레드에서** 처리하는 큐의 특성

그렇다면 분산처리하려는 것이라면 무조건 동시 큐가 좋아보이는데 왜 직렬큐가 필요할까요?



## 스레드의 작업 처리 방식과 큐의 작업 분산 방식 조합

음.. 그럼 4개의 개념은 각각 정리가 되었네요. 그러면 위 개념들을 조합해서는 어떨까요?

|            | Sync                                                         | Async                                                        |
| ---------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| Serial     | 작업을 다른 스레드에서 하도록 시킨 후 그 작업이 끝나길 기다렸다가 다음 작업을 진행합니다. <br>이 때 다른 스레드에 작업을 분산하는 큐의 특성은 Serial입니다. 즉, 메인 스레드에서 분산처리 시킨 작업을 메인 스레드가 아닌 다른 한 개의 스레드에서 처리하도록 합니다(분배합니다.) | 작업을 다른 스레드에서 하도록 시킨 후 그 작업이 끝나길 기다리지 않고 다음 작업을 진행합니다.<br/>이 때 작업을 다른 스레드에 분산하는 큐의 특성은 Serial입니다. 즉, 메인 스레드에서 분산처리 시킨 작업을 메인 스레드가 아닌 다른 한 개의 스레드에서 처리하도록 합니다(분배합니다.) |
| Concurrent | 작업을 다른 스레드에서 하도록 시킨 후 그 작업이 끝나길 기다렸다가 다음 작업을 진행합니다. <br/>이 때 작업을 다른 스레드에 작업을 분산하는 큐의 특성은 Concurrent 입니다. 즉, 메인 스레드에서 분산처리 시킨 작업을 다른 여러 개의 쓰레드에서 처리하도록 합니다(분배합니다.) | 작업을 다른 쓰레드에서 하도록 시킨 후, 그 작업이 끝나길 안 기다리고 다음일을 진행한다. <br/>이 때 다른 스레드에 작업을 분산하는 큐의 특성은  Concurrent입니다. 즉, 메인 스레드에서 분산처리 시킨 작업을 다른 여러 개의 쓰레드에서 처리하도록 합니다.(분배합니다.) |





## 정리

그럼 이제 **비동기(Async)와 동시(Concurrent)는 같은 말일까요?** 이 질문에 대한 답변을 할 수 있겠나요?

동기 / 비동기 개념은 작업을 보내는 시작점에서 작업이 끝날때 까지 기다릴지 말지에 대해 다루는 것입니다.

한편 직렬 / 동시 개념은 큐로 보낸 작업들이 여러 개의 스레드로 갈 것인지 아니면 하나의 스레드로만 갈 것인지에 대해 다루는 것입니다.

그러니까 둘은 다른 개념이라는 것이라고 답할 수 있다면 성공적으로 이해했다고 생각합니다 :)



## 함께 보면 좋을 자료들

(기록해 놨다가 저도 나중에 보려고 씁니다 🐝)



참고

1.

